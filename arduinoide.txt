#include <Servo.h>

// í•€ ì •ì˜ (ì ˆëŒ€ ì°¸ì¡°)
const int SERVO_PIN  = 9;   // ì¡°í–¥ ì„œë³´ PWM í•€
const int ESC_PIN    = 10;  // ì£¼í–‰ ESC PWM í•€

// ì„œë³´ ë° ESC í„ìŠ¤ í­ ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„
const int SERVO_NEUTRAL_US     = 1500;
const int SERVO_MIN_US         = 1000;
const int SERVO_MAX_US         = 2000;
const int ESC_NEUTRAL_US       = 1500;
const int ESC_MAX_FORWARD_US   = 1600; // ìµœëŒ€ ì „ì§„ ì†ë„ ì œí•œ
const int ESC_MAX_REVERSE_US   = 1400; // ìµœëŒ€ í›„ì§„ ì†ë„ ì œí•œ

// P ì œì–´ ì´ë“ (micros per error unit)
const float STEERING_KP = 1.0;

Servo steeringServo;
Servo driveESC;
String inputLine;

void setup() {
  Serial.begin(9600);
  steeringServo.attach(SERVO_PIN);
  driveESC.attach(ESC_PIN);

  // ì¤‘ë¦½ ìƒíƒœ ì„¤ì •
  steeringServo.writeMicroseconds(SERVO_NEUTRAL_US);
  driveESC.writeMicroseconds(ESC_NEUTRAL_US);
  delay(2000);  // ESC ì´ˆê¸°í™” ëŒ€ê¸°

  Serial.println("ğŸš— Arduino ì£¼í–‰ ëª¨ë“œ ì‹œì‘");
}

void loop() {
  if (Serial.available()) {
    inputLine = Serial.readStringUntil('\n');
    inputLine.trim();

    // ìˆ˜ë™ ì œì–´ ëª…ë ¹
    if (inputLine == "F") {
      driveESC.writeMicroseconds(ESC_MAX_FORWARD_US);
      steeringServo.writeMicroseconds(SERVO_NEUTRAL_US);
      Serial.println("â–¶ ìˆ˜ë™: Forward");
    }
    else if (inputLine == "B") {
      driveESC.writeMicroseconds(ESC_MAX_REVERSE_US);
      steeringServo.writeMicroseconds(SERVO_NEUTRAL_US);
      Serial.println("â—€ ìˆ˜ë™: Backward");
    }
    else if (inputLine == "L") {
      int steer_us = constrain(SERVO_NEUTRAL_US - 200, SERVO_MIN_US, SERVO_MAX_US);
      steeringServo.writeMicroseconds(steer_us);
      driveESC.writeMicroseconds(ESC_MAX_FORWARD_US);
      Serial.println("â—¬ ìˆ˜ë™: Left");
    }
    else if (inputLine == "R") {
      int steer_us = constrain(SERVO_NEUTRAL_US + 200, SERVO_MIN_US, SERVO_MAX_US);
      steeringServo.writeMicroseconds(steer_us);
      driveESC.writeMicroseconds(ESC_MAX_FORWARD_US);
      Serial.println("â—® ìˆ˜ë™: Right");
    }
    else if (inputLine == "S") {
      driveESC.writeMicroseconds(ESC_NEUTRAL_US);
      steeringServo.writeMicroseconds(SERVO_NEUTRAL_US);
      Serial.println("â–  ìˆ˜ë™: Stop");
    }
    else {
      // ìë™ ì œì–´: error_x ìˆ«ì ìˆ˜ì‹ 
      int error_x = inputLine.toInt();
      // P ì œì–´ë¡œ ì¡°í–¥ ê°’ ê³„ì‚°
      int steer_us = SERVO_NEUTRAL_US + int(error_x * STEERING_KP);
      steer_us = constrain(steer_us, SERVO_MIN_US, SERVO_MAX_US);
      steeringServo.writeMicroseconds(steer_us);

      // ìë™ ì£¼í–‰ ì‹œ ì „ì§„ ì†ë„ ì œí•œ
      driveESC.writeMicroseconds(ESC_MAX_FORWARD_US);
      Serial.print("â— ìë™: err=");
      Serial.print(error_x);
      Serial.print(" steer_us=");
      Serial.println(steer_us);
    }
  }

  delay(10); // ë£¨í”„ ì†ë„ ì œí•œ
}
