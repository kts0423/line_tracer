#include <Servo.h>

// â”€â”€â”€â”€â”€ í•€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const int ESC_PIN    = 10;  // ì£¼í–‰ìš© ESC ì œì–´ í•€ (PWM)
const int SERVO_PIN  = 9;   // ì¡°í–¥ ì„œë³´ ì œì–´ í•€ (PWM)

Servo driveESC;        // ESC ì œì–´ ê°ì²´
Servo steeringServo;   // ì¡°í–¥ ì„œë³´ ê°ì²´

// â”€â”€â”€â”€â”€ ê¸°ì¤€ê°’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const int STOP_PWM      = 1500;  // ESC ì¤‘ë¦½(ì •ì§€) í„ìŠ¤
const int FORWARD_PWM   = 1560;  // ESC ì „ì§„ í„ìŠ¤
const int REVERSE_PWM   = 1440;  // ESC í›„ì§„ í„ìŠ¤

// â”€â”€â”€â”€â”€ ì¡°í–¥ ì„œë³´ ë³´ì • ë²”ìœ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Python ìª½ steer_angleì€ 50~130 ë²”ìœ„ë¡œ ì „ë‹¬ë¨
// ì‹¤ì œ ì„œë³´ PWM(1100~1900) ë²”ìœ„ì— â€œì—­ìˆœâ€ìœ¼ë¡œ ë§¤í•‘í•˜ë˜(Aâ†’B, Bâ†’A),
// ì—¬ê¸°ì— ì¶”ê°€ë¡œ trimOffset(íŠ¸ë¦¼)ê°’ì„ ë”í•´ ì¤„ ê²ƒ
const int STEER_ANGLE_MIN   = 50;   // Pythonì—ì„œ ì˜¬ ìˆ˜ ìˆëŠ” ìµœì†Œ ê°ë„
const int STEER_ANGLE_MAX   = 130;  // Pythonì—ì„œ ì˜¬ ìˆ˜ ìˆëŠ” ìµœëŒ€ ê°ë„
const int SERVO_PWM_MIN     = 1100; // ì„œë³´ê°€ ìµœëŒ€ ì˜¤ë¥¸ìª½(130ë„)ì¼ ë•Œ í„ìŠ¤ (ì—­ìˆœ ë§¤í•‘)
const int SERVO_PWM_MAX     = 1900; // ì„œë³´ê°€ ìµœëŒ€ ì™¼ìª½(50ë„)ì¼ ë•Œ í„ìŠ¤

// â”€â”€â”€â”€â”€ íŠ¸ë¦¼(ë³´ì •)ê°’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  - positive ê°’: â€œì¤‘ë¦½(90)â€ì— ë”í•´ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë³´ì • 
//  - negative ê°’: â€œì¤‘ë¦½(90)â€ì— ë”í•´ì„œ ì™¼ìª½ìœ¼ë¡œ ë³´ì •
// ì˜ˆë¥¼ ë“¤ì–´ trim = +5 ë©´, Pythonì—ì„œ 90ì„ ë³´ë‚´ë„ ì‹¤ì œ ë§¤í•‘ ì‹œì—ëŠ” 95ë¡œ ì¡°í–¥ë¨.
int steerTrim = 0;

// â”€â”€â”€â”€â”€ ìƒíƒœ ì €ì¥ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
int     currentAngle  = 90;   // â€œì‹¤ì œ ì ìš©í• â€ ì¡°í–¥ ê°ë„ (Python â†’ Arduino)
String  currentDir    = "S";  // â€œí˜„ì¬â€ ì§„í–‰ ë°©í–¥ ("F"/"B"/"S")
bool    hasNewCommand = false; // ìƒˆë¡œìš´ ëª…ë ¹ì´ ë“¤ì–´ì™”ëŠ”ì§€ í”Œë˜ê·¸

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// setup(): ì²˜ìŒ í•œ ë²ˆ ì‹¤í–‰
//  - ì‹œë¦¬ì–¼ í†µì‹  ì‹œì‘
//  - ESC/ì„œë³´ attach, ì¤‘ë¦½ ìƒíƒœ(ì •ì§€)ë¡œ ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void setup() {
  Serial.begin(9600);

  driveESC.attach(ESC_PIN);
  steeringServo.attach(SERVO_PIN);

  // ì´ˆê¸° ì¤‘ë¦½ ìƒíƒœ â†’ ESC ì •ì§€, ì„œë³´ ì¤‘ë¦½(90ë„ + trim)
  driveESC.writeMicroseconds(STOP_PWM);

  // 1) â€œcurrentAngle + trimâ€ ì„ ë¨¼ì € êµ¬í•˜ê³ 
  int initialTrimmed = constrain(currentAngle + steerTrim,
                                 STEER_ANGLE_MIN, STEER_ANGLE_MAX);
  // 2) ê·¸ ê°’ì„ (ì—­ìˆœ) map() í•´ì„œ PWM ì¶œë ¥
  int initPWM = map(initialTrimmed,
                    STEER_ANGLE_MIN, STEER_ANGLE_MAX,
                    SERVO_PWM_MAX, SERVO_PWM_MIN);
  steeringServo.writeMicroseconds(initPWM);

  delay(2000);  // ESC ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ëŒ€ê¸°(2ì´ˆ)

  Serial.println("[OK] RCì¹´ ì¤€ë¹„ ì™„ë£Œ");
  Serial.print("[TRIM] í˜„ì¬ íŠ¸ë¦¼ê°’ = ");
  Serial.println(steerTrim);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// serialEvent(): ì‹œë¦¬ì–¼ ë²„í¼ì— ë°ì´í„°ê°€ ë“¤ì–´ì˜¬ ë•Œ ìë™ í˜¸ì¶œ
//  - í•œ ì¤„('\n' ë˜ëŠ” '\r')ì”© ì½ì–´ì„œ handleCommand()ë¡œ ë„˜ê²¨ ì¤Œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void serialEvent() {
  static String input = "";
  while (Serial.available()) {
    char c = Serial.read();
    if (c == '\n' || c == '\r') {
      if (input.length() > 0) {
        handleCommand(input);
        input = "";
        hasNewCommand = true;  // ìƒˆë¡œìš´ ëª…ë ¹ ë“¤ì–´ì™”ìŒì„ í‘œì‹œ
      }
    } else {
      input += c;
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// loop(): ë°˜ë³µ ì‹¤í–‰
//  - hasNewCommand == true ì¼ ë•Œë§Œ ESC/ì„œë³´ë¥¼ ì—…ë°ì´íŠ¸
//  - ë£¨í”„ ì‚¬ì´ì— ì§§ì€ delayë¥¼ ì£¼ì–´ ì§€ë‚˜ì¹˜ê²Œ ë¹ ë¥´ê²Œ ë„ëŠ” ê±¸ ë°©ì§€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void loop() {
  if (hasNewCommand) {
    // ë°›ì€ ëª…ë ¹ ë””ë²„ê·¸ ì¶œë ¥
    Serial.print("[UPDATE] angle=");
    Serial.print(currentAngle);
    Serial.print("  dir=");
    Serial.println(currentDir);

    // â”€â”€ (1) ì¡°í–¥(Servo) ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  a) â€œcurrentAngle + trimâ€ ì„ ë¨¼ì € ê³„ì‚°
    int trimmedAngle = currentAngle + steerTrim;
    //  b) ë²”ìœ„(50~130)ë¡œ ì œí•œ
    trimmedAngle = constrain(trimmedAngle, STEER_ANGLE_MIN, STEER_ANGLE_MAX);
    //  c) ì—­ìˆœ map: [50 â†â†’ 130] â†’ [1900 â†â†’ 1100]
    int pwmServo = map(trimmedAngle,
                       STEER_ANGLE_MIN, STEER_ANGLE_MAX,
                       SERVO_PWM_MAX, SERVO_PWM_MIN);
    steeringServo.writeMicroseconds(pwmServo);
    Serial.print("ğŸ§­ ì¡°í–¥ PWM â†’ ");
    Serial.print(pwmServo);
    Serial.print("  (trimmedAngle=");
    Serial.print(trimmedAngle);
    Serial.println(")");

    // â”€â”€ (2) ì†ë„(ESC) ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    int pwmESC = STOP_PWM;
    if      (currentDir == "F") pwmESC = FORWARD_PWM;
    else if (currentDir == "B") pwmESC = REVERSE_PWM;
    else                         pwmESC = STOP_PWM;

    // (ì•ë’¤ ë°˜ì „ ì‹œ ë³´í˜¸ìš© ì¤‘ë¦½ í„ìŠ¤)
    static String prevDir = "S";
    if ((prevDir == "F" && currentDir == "B") ||
        (prevDir == "B" && currentDir == "F")) {
      driveESC.writeMicroseconds(STOP_PWM);
      delay(200);  // 200ms ë™ì•ˆ ì •ì§€ í„ìŠ¤ ìœ ì§€ (ESC ë³´í˜¸)
    }
    driveESC.writeMicroseconds(pwmESC);
    Serial.print("âš¡ ESC PWM â†’ ");
    Serial.println(pwmESC);

    prevDir = currentDir;
    Serial.println("-----------------------------");

    hasNewCommand = false;
  }

  // ë„ˆë¬´ ë¹ ë¥´ê²Œ ë„ëŠ” ê±¸ ë°©ì§€í•˜ê¸° ìœ„í•´ ì§§ê²Œ ëŒ€ê¸°
  delay(20);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// handleCommand(cmd):
//  - Pythonì—ì„œ ë³´ë‚¸ â€œE:<angle> D:<dir>â€ ë¬¸ìì—´ì„ íŒŒì‹±
//  - currentAngle ê³¼ currentDir ì„ ì—…ë°ì´íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
void handleCommand(String cmd) {
  cmd.trim();
  Serial.print("[RX] ");
  Serial.println(cmd);

  int e_idx = cmd.indexOf("E:");
  int d_idx = cmd.indexOf("D:");
  if (e_idx != -1 && d_idx != -1) {
    // â”€â”€ (1) ì¡°í–¥ ê°ë„ íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    int angle = cmd.substring(e_idx + 2, d_idx).toInt();
    angle = constrain(angle, STEER_ANGLE_MIN, STEER_ANGLE_MAX);
    currentAngle = angle;

    // â”€â”€ (2) ì§„í–‰ ë°©í–¥ íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    String dir = cmd.substring(d_idx + 2);
    dir.trim();
    dir.toUpperCase();
    if (dir == "F" || dir == "B" || dir == "S") {
      currentDir = dir;
    } else {
      currentDir = "S";
    }

  } else {
    // í¬ë§·ì´ ì´ìƒí•˜ë©´ ì¦‰ì‹œ ì •ì§€ & ì¤‘ë¦½ìœ¼ë¡œ ê°•ì œ
    currentDir = "S";
    currentAngle = 90;  // ì„œë³´ ì¤‘ë¦½
    Serial.println("â›” ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹, ì •ì§€ ì²˜ë¦¬ â†’ " + cmd);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
